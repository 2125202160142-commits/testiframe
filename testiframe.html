<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Sensor Data Chart</title>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.0.14/src/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <style>
        #container {
            height: 400px;
            max-width: 1000px;
            margin: auto;
        }
    </style>
</head>

<body>

<figure class="highcharts-figure">
    <div id="container"></div>
    <button id="exportButton">Export to Excel</button>
</figure>

<script>
/* ================= ERA WIDGET ================= */
const eraWidget = new EraWidget();

let config1 = null;
let config2 = null;

let sensor1Value = 0;
let sensor2Value = 0;

const dataBuffer1 = [];
const dataBuffer2 = [];

eraWidget.onConfiguration((configuration) => {
    config1 = configuration.realtime_configs[0];
    config2 = configuration.realtime_configs[1];
});

eraWidget.onValues((values) => {
    if (config1) sensor1Value = values[config1.id].value;
    if (config2) sensor2Value = values[config2.id].value;
});

eraWidget.ready();

/* ================= INIT DATA ================= */
function initData() {
    const data = [];
    const time = (new Date()).getTime();

    for (let i = -19; i <= 0; i++) {
        data.push({
            x: time + i * 1000,
            y: 0
        });
    }
    return data;
}

const data1 = initData();
const data2 = initData();

/* ================= CHART ================= */
const onChartLoad = function () {
    const chart = this;
    const series1 = chart.series[0];
    const series2 = chart.series[1];

    setInterval(function () {
        const x = (new Date()).getTime();

        // Nếu chưa có sensor2 thật thì demo
        if (!config2) sensor2Value = Math.random() * 100;

        series1.addPoint([x, sensor1Value], true, true);
        series2.addPoint([x, sensor2Value], true, true);

        dataBuffer1.push([x, sensor1Value]);
        dataBuffer2.push([x, sensor2Value]);
    }, 1000);
};

Highcharts.chart('container', {
    chart: {
        type: 'areaspline',
        events: {
            load: onChartLoad
        }
    },

    time: {
        useUTC: false
    },

    title: {
        text: 'Live Sensor Data'
    },

    xAxis: {
        type: 'datetime',
        tickPixelInterval: 150
    },

    yAxis: {
        title: {
            text: 'Value'
        },
        min: 0,
        max: 130,
        tickInterval: 10
    },

    tooltip: {
        shared: true,
        xDateFormat: '%Y-%m-%d %H:%M:%S'
    },

    legend: {
        enabled: true
    },

    exporting: {
        enabled: false
    },

    series: [
        {
            name: 'Sensor 1',
            data: data1,
            color: Highcharts.getOptions().colors[6],
            fillOpacity: 0.3
        },
        {
            name: 'Sensor 2',
            data: data2,
            color: Highcharts.getOptions().colors[2],
            fillOpacity: 0.3
        }
    ]
});

/* ================= EXPORT EXCEL ================= */
document.getElementById('exportButton').addEventListener('click', function () {
    const rows = dataBuffer1.map((p, i) => ({
        Time: new Date(p[0]).toLocaleString(),
        Sensor1: p[1],
        Sensor2: dataBuffer2[i] ? dataBuffer2[i][1] : ''
    }));

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();

    XLSX.utils.book_append_sheet(wb, ws, 'Sensor Data');
    XLSX.writeFile(wb, 'sensor_data.xlsx');
});
</script>

</body>
</html>
