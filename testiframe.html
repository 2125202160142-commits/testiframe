<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Set & RealLevel Data Chart</title>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.0.14/src/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <style>
        .highcharts-figure,
        .highcharts-data-table table {
            min-width: 320px;
            max-width: 1000px;
            margin: 1em auto;
        }

        #container {
            height: 400px;
        }

        .cell {
            height: 220px;
        }

        .highcharts-tooltip {
            font-size: 20px;
        }

        .highcharts-area {
            fill-opacity: 0.3;
        }
    </style>
</head>

<body>

<figure class="highcharts-figure">
    <div id="container"></div>
    <p class="highcharts-description">
        Chart showing Set & RealLevel data updating every second.
    </p>
    <button id="exportButton">Export to Excel</button>
</figure>

<input type="checkbox" id="set"></input>
<input type="checkbox" id="realLevel"></input>

<script>
/* ================= ERA WIDGET ================= */
const eraWidget = new EraWidget();

let setConfig = null;
let realLevelConfig = null;

let setValue = 0;
let realLevelValue = 0;

const setBuffer = [];
const realLevelBuffer = [];

eraWidget.onConfiguration((configuration) => {
    setConfig = configuration.realtime_configs[0];
    realLevelConfig = configuration.realtime_configs[1];
});

eraWidget.onValues((values) => {
    const setInput = document.getElementById('set');
    const realLevelInput = document.getElementById('realLevel');

    if (setConfig) {
        setValue = values[setConfig.id].value;
        setInput.checked = setValue > 0;
    }

    if (realLevelConfig) {
        realLevelValue = values[realLevelConfig.id].value;
        realLevelInput.checked = realLevelValue > 0;
    }
});

eraWidget.ready();

/* ================= CHART LOAD ================= */
const onChartLoad = function () {
    const chart = this;
    const setSeries = chart.series[0];
    const realLevelSeries = chart.series[1];

    setInterval(function () {
        const x = (new Date()).getTime();

        setSeries.addPoint([x, setValue], true, true);
        realLevelSeries.addPoint([x, realLevelValue], true, true);

        setBuffer.push([x, setValue]);
        realLevelBuffer.push([x, realLevelValue]);

        // Giữ dữ liệu 30 phút
        const thirtyMinutesAgo = x - 1800 * 1000;
        while (setBuffer.length && setBuffer[0][0] < thirtyMinutesAgo) {
            setBuffer.shift();
            realLevelBuffer.shift();
        }
    }, 1000);
};

/* ================= INIT DATA ================= */
const setData = (function () {
    const data = [];
    const time = (new Date().getTime());

    for (let i = -19; i <= 0; i++) {
        data.push({ x: time + i * 1000, y: 0 });
    }
    return data;
}());

const realLevelData = (function () {
    const data = [];
    const time = (new Date().getTime());

    for (let i = -19; i <= 0; i++) {
        data.push({ x: time + i * 1000, y: 0 });
    }
    return data;
}());

/* ================= HIGHCHART ================= */
Highcharts.chart('container', {
    chart: {
        type: 'areaspline',
        events: {
            load: onChartLoad
        }
    },

    time: {
        useUTC: false
    },

    title: {
        text: 'Biểu đồ PID'
    },

    xAxis: {
        type: 'datetime',
        tickPixelInterval: 150,
        maxPadding: 0.1
    },

    yAxis: {
        title: {
            text: 'Mực Nước'
        },
        min: 0,
        max: 130,
        tickInterval: 10
    },

    tooltip: {
        headerFormat: '<b>{series.name}</b><br/>',
        pointFormat: '{point.x:%Y-%m-%d %H:%M:%S}<br/>{point.y:.2f}'
    },

    legend: {
        enabled: true
    },

    exporting: {
        enabled: false
    },

    series: [
        {
            name: 'Mực nước mong muốn',
            lineWidth: 2,
            color: Highcharts.getOptions().colors[6],
            data: setData
        },
        {
            name: 'Mực nước thực tế',
            lineWidth: 2,
            color: Highcharts.getOptions().colors[2],
            data: realLevelData
        }
    ]
});

/* ================= EXPORT EXCEL ================= */
document.getElementById('exportButton').addEventListener('click', function () {
    const rows = setBuffer.map((p, i) => ({
        Time: new Date(p[0]).toLocaleString(),
        Set: p[1],
        RealLevel: realLevelBuffer[i] ? realLevelBuffer[i][1] : ''
    }));

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();

    XLSX.utils.book_append_sheet(wb, ws, 'Set_RealLevel');
    XLSX.writeFile(wb, 'Set_RealLevel_Data.xlsx');
});
</script>

</body>
</html>
